<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Items</title>

    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        a {
            color: #337ab7;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        h1 {
            margin-top: 0;
        }

        p {
            margin-bottom: 16px;
        }

        a.back-link {
            display: block;
            margin-top: 16px;
        }
    </style>
</head>
<body>
    <div>
        <table id="table">
            <tr>
                <th>id</th>
                <th>name</th>
                <th>price</th>
            </tr>
            {{#items}}
                <tr>
                    <td>{{id}}</td>
                    <td><a href="/items/{{id}}">{{name}}</a></td>
                    <td>{{price}}</td>
                </tr>
            {{/items}}
        </table>

        <button onclick="order_by_name()" id="btn_order_by_name">Order By Name</button>
        <button onclick="order_by_price()" id="btn_order_by_price">Order By Price</button>
        <button onclick="reset_filters()" id="btn_reset_filters">Reset Filters</button>
    </div>

</body>

<script>

    const WS_URL = "ws://localhost:8080/ws/bid";

    let socket;



    function initWebSocket() {
        socket = new WebSocket(WS_URL);

        socket.onopen = () => {
            console.log("Conectado al servidor WebSocket");
        };

        socket.onerror = (error) => {
            console.log("error al conectar con el web socket");
        }

        socket.onmessage = (event) => {
            const MSG = JSON.parse(event.data);

            handler_web_socket_msg(MSG);

            console.log("On Message: ");
            console.log(MSG);
        }

        socket.onclose = () => {
            console.log("reiniciando web socket");
            setTimeout(initWebSocket, 3000);
        }
    }

    function update_table(data){

        console.log("updated table");

        const table = document.getElementById("table");

        const header = Array.from(table.querySelectorAll("tr"))[0];

        const rows = Array.from(table.querySelectorAll("tr")).slice(1);

        const newRow = table.insertRow(-1);

        const ID = `${data.id}`;
        const NAME = `${data.name}`;
        const PRICE = `${data.price}`;

        const rowData = [ID, NAME, PRICE]; // Data for the new row

        rowData.forEach((item, index) => {
            const newCell = newRow.insertCell(index);
            newCell.innerHTML = item;
        });
    }

    function handler_web_socket_msg(msg){
        const {type, data} = msg;

        switch(type){
            case "new_item":
                console.log("Handler Web Socket New Item");
                update_table(data.item);
                break;

            default:
                console.log("mensaje no encontrado");
                break;
        }
    }

    function order_by_name()
    {
        const table = document.getElementById("table");

        const header = Array.from(table.querySelectorAll("tr"))[0];

        const rows = Array.from(table.querySelectorAll("tr")).slice(1);

        rows.sort((a, b) => {
            const nameA = a.cells[1].innerText.toLowerCase();
            const nameB = b.cells[1].innerText.toLowerCase();
            return nameA.localeCompare(nameB);
        });

        table.innerHTML = "";
        table.appendChild(header);
        rows.forEach(row => table.appendChild(row));
    }

    function order_by_price()
    {
        const table = document.getElementById("table");

        const header = Array.from(table.querySelectorAll("tr"))[0];

        const rows = Array.from(table.querySelectorAll("tr")).slice(1);

        for(let i = 0; i < rows.length; i++)
        {
            for(let j = 0; j < rows.length; j++)
            {
                if(parseFloat(rows[i].cells[2].innerText) > parseFloat(rows[j].cells[2].innerText))
                {
                    let temp = rows[i];
                    rows[i] = rows[j];
                    rows[j] = temp;
                }
            }
        }

        table.innerHTML = "";
        table.appendChild(header);
        rows.forEach(row => table.appendChild(row));
    }

    function reset_filters()
    {
        const table = document.getElementById("table");

        const header = Array.from(table.querySelectorAll("tr"))[0];

        const rows = Array.from(table.querySelectorAll("tr")).slice(1);

        rows.sort((a, b) => {
            const numberA = a.cells[0].innerText;
            const numberB = b.cells[0].innerText;
            return numberA.localeCompare(numberB);
        });

        table.innerHTML = "";
        table.appendChild(header);
        rows.forEach(row => table.appendChild(row));
    }

    document.addEventListener("DOMContentLoaded", initWebSocket);

</script>

</html>